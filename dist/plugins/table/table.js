KindEditor.plugin("table",function(e){var l=this,t="table",o=l.lang("table.");function n(e,l){l=l.toUpperCase(),e.css("background-color",l),e.css("color","#000000"===l?"#FFFFFF":"#000000"),e.html(l)}var i=[];function a(t,o){function a(){e.each(i,function(){this.remove()}),i=[],e(document).unbind("click,mousedown",a),t.unbind("click,mousedown",a)}o.bind("click,mousedown",function(e){e.stopPropagation()}),o.click(function(o){a();var r=e(this),d=r.pos(),c=e.colorpicker({x:d.x,y:d.y+r.height(),z:811214,selectedColor:e(this).html(),colors:l.colorTable,noColor:l.lang("noColor"),shadowMode:l.shadowMode,click:function(e){n(r,e),a()}});i.push(c),e(document).bind("click,mousedown",a),t.bind("click,mousedown",a)})}function r(e,l,t){for(var o=0,n=0,i=l.cells.length;n<i&&l.cells[n]!=t;n++)o+=l.cells[n].rowSpan-1;return t.cellIndex-o}l.plugin.table={quick:function(){var n,i,a,r,d,c,s,p,g,v=e('<div class="ke-plugin-qtable"></div>');for(n='<div class="ke-plugin-qtable-table"><ul>',i=0;i<100;i++)n+='<li index="'+i+'"></li>';n+='</ul><div class="ke-plugin-qtable-selected"></div></div><div class="ke-plugin-qtable-status"><b>0 X 0</b><button>'+o.advanced+"</button></div>",v.html(n),a=v.first(),r=a.last(),d=v.last(),c=d.first(),s=d.last(),a.bind("mousemove",function(e){if("li"===e.target.tagName.toLowerCase()){var l=1*e.target.getAttribute("index"),t=Math.floor(l/10)+1,o=l%10+1;if(t===p&&o===g)return;p=t,g=o,r.css("width",10*g+"%").css("height",10*p+"%"),c.html(g+" X "+p)}}).bind("click",function(){if(p&&g){for(l.hideMenu(),n='<table style="width:100%;" cellpadding="2" cellspacing="0" border="1">',i=0;i<p;i++){n+="<tr>";for(var t=0;t<g;t++)n+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";n+="</tr>"}n+="</table>",e.IE||(n+="<br />"),l.insertHtml(n),l.addBookmark()}}),s.bind("click",function(){l.hideMenu(),l.plugin.table.prop()}),l.createMenu({name:t,addClass:"ke-menu-clear",beforeRemove:function(){a.unbind(),s.unbind()}}).div.append(v)},prop:function(i){var r,d='<div style="padding:20px;"><div class="ke-dialog-row"><label for="keRows">'+o.rows+'</label><input type="text" id="keRows" name="rows" maxlength="4" style="width:96px;"/><label for="keCols" style="margin-left:40px">'+o.cols+'</label><input type="text" id="keCols" name="cols" maxlength="4" style="width:96px;"/></div><div class="ke-dialog-row"><label for="keWidth">'+o.width+'</label><input type="text" id="keWidth" class="ke-input-number" name="width" maxlength="4" /><select name="widthType" style="border-left:0"><option value="%">'+o.percent+'</option><option value="px">'+o.px+'</option></select><label for="keHeight" style="margin-left:40px">'+o.height+'</label><input id="keHeight" type="text" class="ke-input-number" name="height" maxlength="4" /><select name="heightType" style="border-left:0"><option value="%">'+o.percent+'</option><option value="px">'+o.px+'</option></select></div><div class="ke-dialog-row"><label for="kePadding">'+o.padding+'</label><input type="text" id="kePadding" name="padding" maxlength="4" style="width:96px;"/><label for="keSpacing" style="margin-left:40px">'+o.spacing+'</label><input type="text" id="keSpacing" name="spacing" maxlength="4" style="width:96px;" /></div><div class="ke-dialog-row"><label for="keBorderWidth">'+o.borderWidth+'</label><input type="text" id="keBorderWidth" name="border" maxlength="4" style="width:96px;"/><label style="margin-left:40px">'+o.borderColor+'</label><span class="ke-inline-block ke-input-color" style="width:101px;"></span></div><div class="ke-dialog-row"><label>'+o.align+'</label><select name="align" style="width:106px;"><option value="">'+o.alignDefault+'</option><option value="left">'+o.alignLeft+'</option><option value="center">'+o.alignCenter+'</option><option value="right">'+o.alignRight+'</option></select><label style="margin-left:40px">'+o.backgroundColor+'</label><span class="ke-inline-block ke-input-color" style="width:101px;"></span></div></div>',c=l.cmd.range.createBookmark(),s=l.createDialog({name:t,width:470,title:l.lang(t),body:d,beforeRemove:function(){x.unbind()},yesBtn:{name:l.lang("yes"),click:function(t){var o=p.val(),n=g.val(),i=v.val(),a=u.val(),d=h.val(),s=m.val(),S=b.val(),y=f.val(),C=w.val(),B=k.val(),T=e(x[0]).html()||"",A=e(x[1]).html()||"";if(0==o||!/^\d+$/.test(o))return alert(l.lang("invalidRows")),void p[0].focus();if(0==n||!/^\d+$/.test(n))return alert(l.lang("invalidRows")),void g[0].focus();if(!/^\d*$/.test(i))return alert(l.lang("invalidWidth")),void v[0].focus();if(!/^\d*$/.test(a))return alert(l.lang("invalidHeight")),void u[0].focus();if(!/^\d*$/.test(S))return alert(l.lang("invalidPadding")),void b[0].focus();if(!/^\d*$/.test(y))return alert(l.lang("invalidSpacing")),void f[0].focus();if(!/^\d*$/.test(B))return alert(l.lang("invalidBorder")),void k[0].focus();if(r)return""!==i?r.width(i+d):r.css("width",""),void 0!==r[0].width&&r.removeAttr("width"),""!==a?r.height(a+s):r.css("height",""),void 0!==r[0].height&&r.removeAttr("height"),r.css("background-color",A),void 0!==r[0].bgColor&&r.removeAttr("bgColor"),""!==S?r[0].cellPadding=S:r.removeAttr("cellPadding"),""!==y?r[0].cellSpacing=y:r.removeAttr("cellSpacing"),""!==C?r[0].align=C:r.removeAttr("align"),""!==B?r.attr("border",B):r.removeAttr("border"),""===B||"0"===B?r.addClass("ke-zeroborder"):r.removeClass("ke-zeroborder"),""!==T?r.attr("borderColor",T):r.removeAttr("borderColor"),l.hideDialog().focus(),l.cmd.range.moveToBookmark(c),l.cmd.select(),void l.addBookmark();var I="";""!==i&&(I+="width:"+i+d+";"),""!==a&&(I+="height:"+a+s+";"),""!==A&&(I+="background-color:"+A+";");var R="<table";""!==I&&(R+=' style="'+I+'"'),""!==S&&(R+=' cellpadding="'+S+'"'),""!==y&&(R+=' cellspacing="'+y+'"'),""!==C&&(R+=' align="'+C+'"'),""!==B&&(R+=' border="'+B+'"'),""!==B&&"0"!==B||(R+=' class="ke-zeroborder"'),""!==T&&(R+=' bordercolor="'+T+'"'),R+=">";for(var H=0;H<o;H++){R+="<tr>";for(var q=0;q<n;q++)R+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";R+="</tr>"}R+="</table>",e.IE||(R+="<br />"),l.insertHtml(R),l.select().hideDialog().focus(),l.addBookmark()}}}).div,p=e('[name="rows"]',s).val(3),g=e('[name="cols"]',s).val(2),v=e('[name="width"]',s).val(100),u=e('[name="height"]',s),h=e('[name="widthType"]',s),m=e('[name="heightType"]',s),b=e('[name="padding"]',s).val(2),f=e('[name="spacing"]',s).val(0),w=e('[name="align"]',s),k=e('[name="border"]',s).val(1),x=e(".ke-input-color",s);if(a(s,x.eq(0)),a(s,x.eq(1)),n(x.eq(0),""),n(x.eq(1),""),p[0].focus(),p[0].select(),!i&&(r=l.plugin.getSelectedTable())){p.val(r[0].rows.length),g.val(r[0].rows.length>0?r[0].rows[0].cells.length:0),p.attr("disabled",!0),g.attr("disabled",!0);var S,y=r[0].style.width||r[0].width,C=r[0].style.height||r[0].height;void 0!==y&&(S=/^(\d+)((?:px|%)*)$/.exec(y))?(v.val(S[1]),h.val(S[2])):v.val(""),void 0!==C&&(S=/^(\d+)((?:px|%)*)$/.exec(C))&&(u.val(S[1]),m.val(S[2])),b.val(r[0].cellPadding||""),f.val(r[0].cellSpacing||""),w.val(r[0].align||""),k.val(void 0===r[0].border?"":r[0].border),n(x.eq(0),e.toHex(r.attr("borderColor")||"")),n(x.eq(1),e.toHex(r[0].style.backgroundColor||r[0].bgColor||"")),v[0].focus(),v[0].select()}},modifyProp:function(i){var r='<div style="padding:20px;">'+(i?'<div class="ke-dialog-row"><label for="keWidth">'+o.width+'</label><input type="text" id="keWidth" class="ke-input-number" name="width" maxlength="4" /><select name="widthType" style="border-left:0"><option value="%">'+o.percent+'</option><option value="px">'+o.px+'</option></select><label for="keHeight" style="margin-left:40px">'+o.height+'</label><input type="text" id="keHeight" class="ke-input-number" name="height" maxlength="4" /><select name="heightType" style="border-left:0"><option value="%">'+o.percent+'</option><option value="px">'+o.px+"</option></select></div>":'<div class="ke-dialog-row"><label for="keHeight">'+o.height+'</label><input type="text" id="keHeight" class="ke-input-number" name="height" maxlength="4" style="width:101px"/></div>')+'<div class="ke-dialog-row"><label for="keAlign">'+o.textAlign+'</label><select id="keAlign" name="textAlign" style="width:106px"><option value="">'+o.alignDefault+'</option><option value="left">'+o.alignLeft+'</option><option value="center">'+o.alignCenter+'</option><option value="right">'+o.alignRight+'</option></select><label for="verticalAlign" style="margin-left:40px">'+o.verticalAlign+'</label><select name="verticalAlign" style="width:106px"><option value="">'+o.alignDefault+'</option><option value="top">'+o.alignTop+'</option><option value="middle">'+o.alignMiddle+'</option><option value="bottom">'+o.alignBottom+'</option><option value="baseline">'+o.alignBaseline+'</option></select></div><div class="ke-dialog-row"><label>'+o.borderColor+'</label><span class="ke-inline-block ke-input-color" style="width:101px"></span><label style="margin-left:40px">'+o.backgroundColor+'</label><span class="ke-inline-block ke-input-color" style="width:101px"></span></div>'+(i?'<div class="ke-dialog-row"><label for="keBorder">'+o.borderWidth+'</label><input type="text" id="keBorder" class="ke-input-number" name="border" maxlength="4" style="width:96px"/></div>':"")+"\t</div>",d=l.cmd.range.createBookmark(),c=l.createDialog({name:t,width:470,title:l.lang(i?"tablecell":"tablerowprop"),body:r,beforeRemove:function(){v.unbind()},yesBtn:{name:l.lang("yes"),click:function(t){var o=s.val(),n=p.val(),a=g.val(),r=e(v[0]).html()||"",c=e(v[1]).html()||"";if(i){var w=h.val(),k=m.val(),x=u.val(),S=b.val();if(!/^\d*$/.test(w))return alert(l.lang("invalidWidth")),void h[0].focus()}if(!/^\d*$/.test(o))return alert(l.lang("invalidHeight")),void s[0].focus();if(i&&!/^\d*$/.test(S))return alert(l.lang("invalidBorder")),void b[0].focus();var y={height:o?o+(i?x:"px"):"","text-align":n,"vertical-align":a,"background-color":c,"border-color":r};i&&(y.width=w?w+k:"",y["border-width"]=S),f.css(y),l.hideDialog().focus(),l.cmd.range.moveToBookmark(d),l.cmd.select(),l.addBookmark()}}}).div,s=e('[name="height"]',c),p=e('[name="textAlign"]',c),g=e('[name="verticalAlign"]',c),v=e(".ke-input-color",c),u=i?e('[name="heightType"]',c):null,h=i?e('[name="width"]',c):null,m=i?e('[name="widthType"]',c):null,b=i?e('[name="border"]',c):null,f=i?l.plugin.getSelectedCell():l.plugin.getSelectedRow(),w=f[0],k=w.style;a(c,v.eq(0)),a(c,v.eq(1)),n(v.eq(0),e.toHex(k.borderColor||"")),n(v.eq(1),e.toHex(k.backgroundColor||"")),p.val(k.textAlign||w.align||""),g.val(k.verticalAlign||w.valign||"");var x,S=k.height||w.height||"";if((x=/^(\d+)((?:px|%)*)$/.exec(S))&&(s.val(x[1]),i&&u.val(x[2])),i){var y=k.width||w.width||"";(x=/^(\d+)((?:px|%)*)$/.exec(y))&&(h.val(x[1]),m.val(x[2]));var C=k.borderWidth||"";C&&(C=parseInt(C)),b.val(C),h[0].focus(),h[0].select()}else s[0].focus(),s[0].select()},rowprop:function(){this.modifyProp()},cellprop:function(){this.modifyProp(!0)},insert:function(){this.prop(!0)},remove:function(){var e=l.plugin.getSelectedTable();l.cmd.range.setStartBefore(e[0]).collapse(!0),l.cmd.select(),e.remove(),l.addBookmark()},colinsert:function(t){var o=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],i=l.plugin.getSelectedCell()[0],a=i.cellIndex+t;a+=o.rows[0].cells.length-n.cells.length;for(var d=0,c=o.rows.length;d<c;d++){var s=o.rows[d],p=s.insertCell(a);p.innerHTML=e.IE?"":"<br />",a=r(0,s,p)}l.cmd.range.selectNodeContents(i).collapse(!0),l.cmd.select(),l.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(t){var o=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],i=l.plugin.getSelectedCell()[0],a=n.rowIndex;1===t&&(a=n.rowIndex+(i.rowSpan-1)+t);for(var r=o.insertRow(a),d=0,c=n.cells.length;d<c;d++){n.cells[d].rowSpan>1&&(c-=n.cells[d].rowSpan-1);var s=r.insertCell(d);1===t&&n.cells[d].colSpan>1&&(s.colSpan=n.cells[d].colSpan),s.innerHTML=e.IE?"":"<br />"}for(var p=a;p>=0;p--){var g=o.rows[p].cells;if(g.length>d){for(var v=i.cellIndex;v>=0;v--)g[v].rowSpan>1&&(g[v].rowSpan+=1);break}}l.cmd.range.selectNodeContents(i).collapse(!0),l.cmd.select(),l.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=l.plugin.getSelectedTable()[0],t=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],n=t.rowIndex+o.rowSpan,i=e.rows[n];if(!(e.rows.length<=n)){var a=o.cellIndex;if(!(i.cells.length<=a)){var r=i.cells[a];o.colSpan===r.colSpan&&(o.rowSpan+=r.rowSpan,i.deleteCell(a),l.cmd.range.selectNodeContents(o).collapse(!0),l.cmd.select(),l.addBookmark())}}},colmerge:function(){l.plugin.getSelectedTable()[0];var e=l.plugin.getSelectedRow()[0],t=l.plugin.getSelectedCell()[0],o=(e.rowIndex,t.cellIndex+1);if(!(e.cells.length<=o)){var n=e.cells[o];t.rowSpan===n.rowSpan&&(t.colSpan+=n.colSpan,e.deleteCell(o),l.cmd.range.selectNodeContents(t).collapse(!0),l.cmd.select(),l.addBookmark())}},rowsplit:function(){var t=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0],i=o.rowIndex;if(1!==n.rowSpan){for(var a=r(0,o,n),d=1,c=n.rowSpan;d<c;d++){var s=t.rows[i+d],p=s.insertCell(a);n.colSpan>1&&(p.colSpan=n.colSpan),p.innerHTML=e.IE?"":"<br />",a=r(0,s,p)}e(n).removeAttr("rowSpan"),l.cmd.range.selectNodeContents(n).collapse(!0),l.cmd.select(),l.addBookmark()}},colsplit:function(){l.plugin.getSelectedTable()[0];var t=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],n=o.cellIndex;if(1!==o.colSpan){for(var i=1,a=o.colSpan;i<a;i++){var r=t.insertCell(n+i);o.rowSpan>1&&(r.rowSpan=o.rowSpan),r.innerHTML=e.IE?"":"<br />"}e(o).removeAttr("colSpan"),l.cmd.range.selectNodeContents(o).collapse(!0),l.cmd.select(),l.addBookmark()}},coldelete:function(){for(var t=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0].cellIndex,i=0,a=t.rows.length;i<a;i++){var r=t.rows[i],d=r.cells[n];d.colSpan>1?(d.colSpan-=1,1===d.colSpan&&e(d).removeAttr("colSpan")):r.deleteCell(n),d.rowSpan>1&&(i+=d.rowSpan-1)}0===o.cells.length?(l.cmd.range.setStartBefore(t).collapse(!0),l.cmd.select(),e(t).remove()):l.cmd.selection(!0),l.addBookmark()},rowdelete:function(){for(var t=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0],i=o.rowIndex,a=n.rowSpan-1;a>=0;a--)t.deleteRow(i+a);0===t.rows.length?(l.cmd.range.setStartBefore(t).collapse(!0),l.cmd.select(),e(t).remove()):l.cmd.selection(!0),l.addBookmark()}},l.clickToolbar(t,l.plugin.table.quick)});